<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="K8s 源码分析 —— scheduler（一） 基于 release-1.25 分支的代码分析
一，疑问 Question：调度器挑选节点时，是根据节点当前的真实压力，还是根据 pod 的 request 值？
Answer：是根据 pod 的 request 来判断的，但有些插件在尝试根据节点真实压力来判断。
具体代码位于：pkg/scheduler/framework/plugins/noderesources/fit.go#L253
二，代码分析 1，概括 AdmissionCheck() ——&amp;gt; Fits() ——&amp;gt; fitsRequest(computePodResourceRequest(pod), nodeInfo, nil, nil) picture 2，局部逻辑 2.1 computePodResourceRequest(pod)： 计算 pod 的资源申请量：pod 里面分 init 容器和普通容器，由于 init 容器是顺序运行的，所以取最大值（initMax） 就行，而普通容器取申请值总和（sum），然后再在取 max(initMax，sum) 作为最后的结果。
Example: Pod: InitContainers IC1: CPU: 2 Memory: 1G IC2: CPU: 2 Memory: 3G Containers C1: CPU: 2 Memory: 1G C2: CPU: 1 Memory: 1G Result: CPU: 3, Memory: 3G 大致逻辑："><title></title><link rel=canonical href=https://ldsdsy.github.io/p/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content><meta property="og:description" content="K8s 源码分析 —— scheduler（一） 基于 release-1.25 分支的代码分析
一，疑问 Question：调度器挑选节点时，是根据节点当前的真实压力，还是根据 pod 的 request 值？
Answer：是根据 pod 的 request 来判断的，但有些插件在尝试根据节点真实压力来判断。
具体代码位于：pkg/scheduler/framework/plugins/noderesources/fit.go#L253
二，代码分析 1，概括 AdmissionCheck() ——&amp;gt; Fits() ——&amp;gt; fitsRequest(computePodResourceRequest(pod), nodeInfo, nil, nil) picture 2，局部逻辑 2.1 computePodResourceRequest(pod)： 计算 pod 的资源申请量：pod 里面分 init 容器和普通容器，由于 init 容器是顺序运行的，所以取最大值（initMax） 就行，而普通容器取申请值总和（sum），然后再在取 max(initMax，sum) 作为最后的结果。
Example: Pod: InitContainers IC1: CPU: 2 Memory: 1G IC2: CPU: 2 Memory: 3G Containers C1: CPU: 2 Memory: 1G C2: CPU: 1 Memory: 1G Result: CPU: 3, Memory: 3G 大致逻辑："><meta property="og:url" content="https://ldsdsy.github.io/p/"><meta property="og:site_name" content="ldsdsy Site"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta name=twitter:title content><meta name=twitter:description content="K8s 源码分析 —— scheduler（一） 基于 release-1.25 分支的代码分析
一，疑问 Question：调度器挑选节点时，是根据节点当前的真实压力，还是根据 pod 的 request 值？
Answer：是根据 pod 的 request 来判断的，但有些插件在尝试根据节点真实压力来判断。
具体代码位于：pkg/scheduler/framework/plugins/noderesources/fit.go#L253
二，代码分析 1，概括 AdmissionCheck() ——&amp;gt; Fits() ——&amp;gt; fitsRequest(computePodResourceRequest(pod), nodeInfo, nil, nil) picture 2，局部逻辑 2.1 computePodResourceRequest(pod)： 计算 pod 的资源申请量：pod 里面分 init 容器和普通容器，由于 init 容器是顺序运行的，所以取最大值（initMax） 就行，而普通容器取申请值总和（sum），然后再在取 max(initMax，sum) 作为最后的结果。
Example: Pod: InitContainers IC1: CPU: 2 Memory: 1G IC2: CPU: 2 Memory: 3G Containers C1: CPU: 2 Memory: 1G C2: CPU: 1 Memory: 1G Result: CPU: 3, Memory: 3G 大致逻辑："></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=https://ldsdsy.github.io/ class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><h2 class=article-title><a href=/p/></a></h2><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>2 minute read</time></div></footer></div></header><section class=article-content><h1 id=k8s-源码分析--scheduler一>K8s 源码分析 —— scheduler（一）</h1><p><em>基于 release-1.25 分支的代码分析</em></p><h2 id=一疑问>一，疑问</h2><p>Question：调度器挑选节点时，是根据节点当前的真实压力，还是根据 pod 的 request 值？</p><p>Answer：是根据 pod 的 request 来判断的，但有些插件在尝试根据节点真实压力来判断。<br>具体代码位于：pkg/scheduler/framework/plugins/noderesources/fit.go#L253</p><h2 id=二代码分析>二，代码分析</h2><h3 id=1概括>1，概括</h3><p>AdmissionCheck() ——> Fits() ——> fitsRequest(computePodResourceRequest(pod), nodeInfo, nil, nil)<br><figure><a href=/image/scheduler1-1.png><img src=/image/scheduler1-1.png loading=lazy alt=picture></a><figcaption>picture</figcaption></figure></p><h3 id=2局部逻辑>2，局部逻辑</h3><h3 id=21-computepodresourcerequestpod>2.1 computePodResourceRequest(pod)：</h3><p><em>计算 pod 的资源申请量：pod 里面分 init 容器和普通容器，由于 init 容器是顺序运行的，所以取最大值（initMax） 就行，而普通容器取申请值总和（sum），然后再在取 max(initMax，sum) 作为最后的结果。</em></p><pre tabindex=0><code> Example:

 Pod:

    InitContainers
        IC1:
        CPU: 2
        Memory: 1G
        IC2:
        CPU: 2
        Memory: 3G
    Containers
        C1:
        CPU: 2
        Memory: 1G
        C2:
        CPU: 1
        Memory: 1G

 Result: CPU: 3, Memory: 3G
</code></pre><p>大致逻辑：<br>1，遍历普通容器，把对应资源进行相加操作；<br>2，遍历 init 容器，对比 1 里的结果和当前 init 容器每一项资源大小，取大值；<br>3，如果存在 pod.Spec.Overhead，把 2 的结果再加上 pod.Spec.Overhead 返回。</p><h3 id=22-fitsrequest>2.2 fitsRequest()：</h3><p><em>根据 2.1 里得到的 pod 所需资源与当前节点上剩余资源相对比，判断各个资源是否够用，记录容量不足的资源返回上一层函数。</em></p><p>大致逻辑：<br>1，定义一个变量 insufficientResources，里面用来存放当前节点资源不足的信息；<br>2，如果当前节点上所运行着的 pod 数量 +1 > 此节点所允许运行的 pod 数量，则记录：</p><pre tabindex=0><code>&#34;Too many pods&#34; &gt;&gt; insufficientResources
</code></pre><p>3，如果此 pod 申请的各种资源大小全为 0，到此直接返回 insufficientResources；<br>4，如果此 pod 申请的 cpu > (此节点可分配的 cpu - 此节点上所有 pod 的 cpu 申请量总和)，则记录：</p><pre tabindex=0><code>&#34;Insufficient cpu&#34; &gt;&gt; insufficientResources
</code></pre><p>5，如果此 pod 申请的 memory > (此节点可分配的 memory - 此节点上所有 pod 的 memory 申请量总和)，则记录：</p><pre tabindex=0><code>&#34;Insufficient memory&#34; &gt;&gt; insufficientResources
</code></pre><p>6，如果此 pod 申请的临时存储容量 > (此节点可分配的临时存储容量 - 此节点上所有 pod 的临时存储容申请量总和)，则记录：</p><pre tabindex=0><code>&#34;Insufficient ephemeral-storage&#34; &gt;&gt; insufficientResources
</code></pre><p>7，遍历 ScalarResources，如果其中某一项资源申请量 > (此节点可分配 - 此节点上所有 pod 申请总和)，则记录：</p><pre tabindex=0><code>(&#34;Insufficient %v&#34;, rName) &gt;&gt; insufficientResources
</code></pre><p>8，返回 insufficientResources 。</p><h3 id=23-admissioncheck>2.3 AdmissionCheck()：</h3><p><em>检查当前节点是否可调度当前 pod，从资源，节点亲和性等各个方面进行判断。</em></p><p>大致逻辑：<br>1，定义一个变量 admissionResults，用来存放当前节点是否符合调度 pod 的结果；<br>2，获取到 Fits() 返回的 insufficientResources；<br>3，判断 insufficientResources 是否为空，不为空则遍历 insufficientResources，追加到 admissionResults；<br>4，判断 pod 的 nodeSelector 和 nodeAffinity 是否和节点相匹配，不匹配就把相关信息追加到 admissionResults；</p><pre tabindex=0><code>&#34;node(s) didn&#39;t match Pod&#39;s node affinity/selector&#34;  
</code></pre><p>5，判断 pod.Spec.NodeName 是否和当前节点名称匹配，不匹配就把相关信息追加到 admissionResults；</p><pre tabindex=0><code>&#34;node(s) didn&#39;t match the requested node name&#34;   
</code></pre><p>6，判断 pod 里所有容器申请的端口信息与当前节点已使用的端口有冲突，如果有就把相关信息追加到 admissionResults；</p><pre tabindex=0><code>&#34;node(s) didn&#39;t have free ports for the requested pod ports&#34;    
</code></pre><p>7，返回 admissionResults，在 3～6 中，如果当前不要求返回所有不匹配信息(includeAllFailures==false)，在遇到第一个不匹配信息就会直接返回 admissionResults。</p><h2 id=三总结>三，总结</h2><p>Scheduler 调度 pod 时，是根据资源申请值来判断当前节点是否可选择的。<br>// 如果根据申请值判断出此节点还剩 1C1G 资源可以调度，但可能已运行的 pod 在使用的资源是大于申请量的，所以节点实际没有 1C1G 那么是否会调度上去呢？</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2023 ldsdsy Site</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#一疑问>一，疑问</a></li><li><a href=#二代码分析>二，代码分析</a><ol><li><a href=#1概括>1，概括</a></li><li><a href=#2局部逻辑>2，局部逻辑</a></li><li><a href=#21-computepodresourcerequestpod>2.1 computePodResourceRequest(pod)：</a></li><li><a href=#22-fitsrequest>2.2 fitsRequest()：</a></li><li><a href=#23-admissioncheck>2.3 AdmissionCheck()：</a></li></ol></li><li><a href=#三总结>三，总结</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>